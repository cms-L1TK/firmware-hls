# Script to generate project for TE
#   vivado_hls -f script_TE.tcl
#   vivado_hls -p trackletEngine
# WARNING: this will wipe out the original project by the same name

# get some information about the executable and environment
source env_hls.tcl

set modules_to_test {
  {TE_L1PHIA1_L2PHIA1}
  {TE_L1PHIA1_L2PHIA2}
  {TE_L1PHIA1_L2PHIA3}
  {TE_L1PHIA2_L2PHIA1}
  {TE_L1PHIA2_L2PHIA2}
  {TE_L1PHIA2_L2PHIA3}
  {TE_L1PHIA2_L2PHIA4}
  {TE_L1PHIA3_L2PHIA1}
  {TE_L1PHIA3_L2PHIA2}
  {TE_L1PHIA3_L2PHIA3}
  {TE_L1PHIA3_L2PHIA4}
  {TE_L1PHIA3_L2PHIA5}
  {TE_L1PHIA4_L2PHIA2}
  {TE_L1PHIA4_L2PHIA3}
  {TE_L1PHIA4_L2PHIA4}
  {TE_L1PHIA4_L2PHIA5}
  {TE_L1PHIA4_L2PHIA6}
  {TE_L1PHIB5_L2PHIA3}
  {TE_L1PHIB5_L2PHIA4}
  {TE_L1PHIB5_L2PHIA5}
  {TE_L1PHIB5_L2PHIA6}
  {TE_L1PHIB5_L2PHIA7}
  {TE_L1PHIB6_L2PHIA4}
  {TE_L1PHIB6_L2PHIA5}
  {TE_L1PHIB6_L2PHIA6}
  {TE_L1PHIB6_L2PHIA7}
  {TE_L1PHIB6_L2PHIA8}
  {TE_L1PHIB7_L2PHIA5}
  {TE_L1PHIB7_L2PHIA6}
  {TE_L1PHIB7_L2PHIA7}
  {TE_L1PHIB7_L2PHIA8}
  {TE_L1PHIB7_L2PHIB9}
  {TE_L1PHIB8_L2PHIA6}
  {TE_L1PHIB8_L2PHIA7}
  {TE_L1PHIB8_L2PHIA8}
  {TE_L1PHIB8_L2PHIB10}
  {TE_L1PHIB8_L2PHIB9}
  {TE_L1PHIC10_L2PHIA8}
  {TE_L1PHIC10_L2PHIB10}
  {TE_L1PHIC10_L2PHIB11}
  {TE_L1PHIC10_L2PHIB12}
  {TE_L1PHIC10_L2PHIB9}
  {TE_L1PHIC11_L2PHIB10}
  {TE_L1PHIC11_L2PHIB11}
  {TE_L1PHIC11_L2PHIB12}
  {TE_L1PHIC11_L2PHIB13}
  {TE_L1PHIC11_L2PHIB9}
  {TE_L1PHIC12_L2PHIB10}
  {TE_L1PHIC12_L2PHIB11}
  {TE_L1PHIC12_L2PHIB12}
  {TE_L1PHIC12_L2PHIB13}
  {TE_L1PHIC12_L2PHIB14}
  {TE_L1PHIC9_L2PHIA7}
  {TE_L1PHIC9_L2PHIA8}
  {TE_L1PHIC9_L2PHIB10}
  {TE_L1PHIC9_L2PHIB11}
  {TE_L1PHIC9_L2PHIB9}
  {TE_L1PHID13_L2PHIB11}
  {TE_L1PHID13_L2PHIB12}
  {TE_L1PHID13_L2PHIB13}
  {TE_L1PHID13_L2PHIB14}
  {TE_L1PHID13_L2PHIB15}
  {TE_L1PHID14_L2PHIB12}
  {TE_L1PHID14_L2PHIB13}
  {TE_L1PHID14_L2PHIB14}
  {TE_L1PHID14_L2PHIB15}
  {TE_L1PHID14_L2PHIB16}
  {TE_L1PHID15_L2PHIB13}
  {TE_L1PHID15_L2PHIB14}
  {TE_L1PHID15_L2PHIB15}
  {TE_L1PHID15_L2PHIB16}
  {TE_L1PHID15_L2PHIC17}
  {TE_L1PHID16_L2PHIB14}
  {TE_L1PHID16_L2PHIB15}
  {TE_L1PHID16_L2PHIB16}
  {TE_L1PHID16_L2PHIC17}
  {TE_L1PHID16_L2PHIC18}
  {TE_L1PHIE17_L2PHIB15}
  {TE_L1PHIE17_L2PHIB16}
  {TE_L1PHIE17_L2PHIC17}
  {TE_L1PHIE17_L2PHIC18}
  {TE_L1PHIE17_L2PHIC19}
  {TE_L1PHIE18_L2PHIB16}
  {TE_L1PHIE18_L2PHIC17}
  {TE_L1PHIE18_L2PHIC18}
  {TE_L1PHIE18_L2PHIC19}
  {TE_L1PHIE18_L2PHIC20}
  {TE_L1PHIE19_L2PHIC17}
  {TE_L1PHIE19_L2PHIC18}
  {TE_L1PHIE19_L2PHIC19}
  {TE_L1PHIE19_L2PHIC20}
  {TE_L1PHIE19_L2PHIC21}
  {TE_L1PHIE20_L2PHIC18}
  {TE_L1PHIE20_L2PHIC19}
  {TE_L1PHIE20_L2PHIC20}
  {TE_L1PHIE20_L2PHIC21}
  {TE_L1PHIE20_L2PHIC22}
  {TE_L1PHIF21_L2PHIC19}
  {TE_L1PHIF21_L2PHIC20}
  {TE_L1PHIF21_L2PHIC21}
  {TE_L1PHIF21_L2PHIC22}
  {TE_L1PHIF21_L2PHIC23}
  {TE_L1PHIF22_L2PHIC20}
  {TE_L1PHIF22_L2PHIC21}
  {TE_L1PHIF22_L2PHIC22}
  {TE_L1PHIF22_L2PHIC23}
  {TE_L1PHIF22_L2PHIC24}
  {TE_L1PHIF23_L2PHIC21}
  {TE_L1PHIF23_L2PHIC22}
  {TE_L1PHIF23_L2PHIC23}
  {TE_L1PHIF23_L2PHIC24}
  {TE_L1PHIF23_L2PHID25}
  {TE_L1PHIF24_L2PHIC22}
  {TE_L1PHIF24_L2PHIC23}
  {TE_L1PHIF24_L2PHIC24}
  {TE_L1PHIF24_L2PHID25}
  {TE_L1PHIF24_L2PHID26}
  {TE_L1PHIG25_L2PHIC23}
  {TE_L1PHIG25_L2PHIC24}
  {TE_L1PHIG25_L2PHID25}
  {TE_L1PHIG25_L2PHID26}
  {TE_L1PHIG25_L2PHID27}
  {TE_L1PHIG26_L2PHIC24}
  {TE_L1PHIG26_L2PHID25}
  {TE_L1PHIG26_L2PHID26}
  {TE_L1PHIG26_L2PHID27}
  {TE_L1PHIG26_L2PHID28}
  {TE_L1PHIG27_L2PHID25}
  {TE_L1PHIG27_L2PHID26}
  {TE_L1PHIG27_L2PHID27}
  {TE_L1PHIG27_L2PHID28}
  {TE_L1PHIG27_L2PHID29}
  {TE_L1PHIG28_L2PHID26}
  {TE_L1PHIG28_L2PHID27}
  {TE_L1PHIG28_L2PHID28}
  {TE_L1PHIG28_L2PHID29}
  {TE_L1PHIG28_L2PHID30}
  {TE_L1PHIH29_L2PHID27}
  {TE_L1PHIH29_L2PHID28}
  {TE_L1PHIH29_L2PHID29}
  {TE_L1PHIH29_L2PHID30}
  {TE_L1PHIH29_L2PHID31}
  {TE_L1PHIH30_L2PHID28}
  {TE_L1PHIH30_L2PHID29}
  {TE_L1PHIH30_L2PHID30}
  {TE_L1PHIH30_L2PHID31}
  {TE_L1PHIH30_L2PHID32}
  {TE_L1PHIH31_L2PHID29}
  {TE_L1PHIH31_L2PHID30}
  {TE_L1PHIH31_L2PHID31}
  {TE_L1PHIH31_L2PHID32}
  {TE_L1PHIH32_L2PHID30}
  {TE_L1PHIH32_L2PHID31}
  {TE_L1PHIH32_L2PHID32}
  {TE_L2PHII1_L3PHII1}
  {TE_L2PHII1_L3PHII2}
  {TE_L2PHII2_L3PHII1}
  {TE_L2PHII2_L3PHII2}
  {TE_L2PHII2_L3PHII3}
  {TE_L2PHII3_L3PHII2}
  {TE_L2PHII3_L3PHII3}
  {TE_L2PHII3_L3PHII4}
  {TE_L2PHII4_L3PHII3}
  {TE_L2PHII4_L3PHII4}
  {TE_L2PHII4_L3PHIJ5}
  {TE_L2PHIJ5_L3PHII4}
  {TE_L2PHIJ5_L3PHIJ5}
  {TE_L2PHIJ5_L3PHIJ6}
  {TE_L2PHIJ6_L3PHIJ5}
  {TE_L2PHIJ6_L3PHIJ6}
  {TE_L2PHIJ6_L3PHIJ7}
  {TE_L2PHIJ7_L3PHIJ6}
  {TE_L2PHIJ7_L3PHIJ7}
  {TE_L2PHIJ7_L3PHIJ8}
  {TE_L2PHIJ8_L3PHIJ7}
  {TE_L2PHIJ8_L3PHIJ8}
  {TE_L2PHIJ8_L3PHIK9}
  {TE_L2PHIK10_L3PHIK10}
  {TE_L2PHIK10_L3PHIK11}
  {TE_L2PHIK10_L3PHIK9}
  {TE_L2PHIK11_L3PHIK10}
  {TE_L2PHIK11_L3PHIK11}
  {TE_L2PHIK11_L3PHIK12}
  {TE_L2PHIK12_L3PHIK11}
  {TE_L2PHIK12_L3PHIK12}
  {TE_L2PHIK12_L3PHIL13}
  {TE_L2PHIK9_L3PHIJ8}
  {TE_L2PHIK9_L3PHIK10}
  {TE_L2PHIK9_L3PHIK9}
  {TE_L2PHIL13_L3PHIK12}
  {TE_L2PHIL13_L3PHIL13}
  {TE_L2PHIL13_L3PHIL14}
  {TE_L2PHIL14_L3PHIL13}
  {TE_L2PHIL14_L3PHIL14}
  {TE_L2PHIL14_L3PHIL15}
  {TE_L2PHIL15_L3PHIL14}
  {TE_L2PHIL15_L3PHIL15}
  {TE_L2PHIL15_L3PHIL16}
  {TE_L2PHIL16_L3PHIL15}
  {TE_L2PHIL16_L3PHIL16}
  {TE_L3PHIA1_L4PHIA1}
  {TE_L3PHIA1_L4PHIA2}
  {TE_L3PHIA1_L4PHIA3}
  {TE_L3PHIA1_L4PHIA4}
  {TE_L3PHIA2_L4PHIA1}
  {TE_L3PHIA2_L4PHIA2}
  {TE_L3PHIA2_L4PHIA3}
  {TE_L3PHIA2_L4PHIA4}
  {TE_L3PHIA2_L4PHIA5}
  {TE_L3PHIA2_L4PHIA6}
  {TE_L3PHIA3_L4PHIA3}
  {TE_L3PHIA3_L4PHIA4}
  {TE_L3PHIA3_L4PHIA5}
  {TE_L3PHIA3_L4PHIA6}
  {TE_L3PHIA3_L4PHIA7}
  {TE_L3PHIA3_L4PHIA8}
  {TE_L3PHIA4_L4PHIA5}
  {TE_L3PHIA4_L4PHIA6}
  {TE_L3PHIA4_L4PHIA7}
  {TE_L3PHIA4_L4PHIA8}
  {TE_L3PHIA4_L4PHIB10}
  {TE_L3PHIA4_L4PHIB9}
  {TE_L3PHIB5_L4PHIA7}
  {TE_L3PHIB5_L4PHIA8}
  {TE_L3PHIB5_L4PHIB10}
  {TE_L3PHIB5_L4PHIB11}
  {TE_L3PHIB5_L4PHIB12}
  {TE_L3PHIB5_L4PHIB9}
  {TE_L3PHIB6_L4PHIB10}
  {TE_L3PHIB6_L4PHIB11}
  {TE_L3PHIB6_L4PHIB12}
  {TE_L3PHIB6_L4PHIB13}
  {TE_L3PHIB6_L4PHIB14}
  {TE_L3PHIB6_L4PHIB9}
  {TE_L3PHIB7_L4PHIB11}
  {TE_L3PHIB7_L4PHIB12}
  {TE_L3PHIB7_L4PHIB13}
  {TE_L3PHIB7_L4PHIB14}
  {TE_L3PHIB7_L4PHIB15}
  {TE_L3PHIB7_L4PHIB16}
  {TE_L3PHIB8_L4PHIB13}
  {TE_L3PHIB8_L4PHIB14}
  {TE_L3PHIB8_L4PHIB15}
  {TE_L3PHIB8_L4PHIB16}
  {TE_L3PHIB8_L4PHIC17}
  {TE_L3PHIB8_L4PHIC18}
  {TE_L3PHIC10_L4PHIC17}
  {TE_L3PHIC10_L4PHIC18}
  {TE_L3PHIC10_L4PHIC19}
  {TE_L3PHIC10_L4PHIC20}
  {TE_L3PHIC10_L4PHIC21}
  {TE_L3PHIC10_L4PHIC22}
  {TE_L3PHIC11_L4PHIC19}
  {TE_L3PHIC11_L4PHIC20}
  {TE_L3PHIC11_L4PHIC21}
  {TE_L3PHIC11_L4PHIC22}
  {TE_L3PHIC11_L4PHIC23}
  {TE_L3PHIC11_L4PHIC24}
  {TE_L3PHIC12_L4PHIC21}
  {TE_L3PHIC12_L4PHIC22}
  {TE_L3PHIC12_L4PHIC23}
  {TE_L3PHIC12_L4PHIC24}
  {TE_L3PHIC12_L4PHID25}
  {TE_L3PHIC12_L4PHID26}
  {TE_L3PHIC9_L4PHIB15}
  {TE_L3PHIC9_L4PHIB16}
  {TE_L3PHIC9_L4PHIC17}
  {TE_L3PHIC9_L4PHIC18}
  {TE_L3PHIC9_L4PHIC19}
  {TE_L3PHIC9_L4PHIC20}
  {TE_L3PHID13_L4PHIC23}
  {TE_L3PHID13_L4PHIC24}
  {TE_L3PHID13_L4PHID25}
  {TE_L3PHID13_L4PHID26}
  {TE_L3PHID13_L4PHID27}
  {TE_L3PHID13_L4PHID28}
  {TE_L3PHID14_L4PHID25}
  {TE_L3PHID14_L4PHID26}
  {TE_L3PHID14_L4PHID27}
  {TE_L3PHID14_L4PHID28}
  {TE_L3PHID14_L4PHID29}
  {TE_L3PHID14_L4PHID30}
  {TE_L3PHID15_L4PHID27}
  {TE_L3PHID15_L4PHID28}
  {TE_L3PHID15_L4PHID29}
  {TE_L3PHID15_L4PHID30}
  {TE_L3PHID15_L4PHID31}
  {TE_L3PHID15_L4PHID32}
  {TE_L3PHID16_L4PHID29}
  {TE_L3PHID16_L4PHID30}
  {TE_L3PHID16_L4PHID31}
  {TE_L3PHID16_L4PHID32}
  {TE_L5PHIA1_L6PHIA1}
  {TE_L5PHIA1_L6PHIA2}
  {TE_L5PHIA1_L6PHIA3}
  {TE_L5PHIA1_L6PHIA4}
  {TE_L5PHIA1_L6PHIA5}
  {TE_L5PHIA2_L6PHIA1}
  {TE_L5PHIA2_L6PHIA2}
  {TE_L5PHIA2_L6PHIA3}
  {TE_L5PHIA2_L6PHIA4}
  {TE_L5PHIA2_L6PHIA5}
  {TE_L5PHIA2_L6PHIA6}
  {TE_L5PHIA2_L6PHIA7}
  {TE_L5PHIA3_L6PHIA2}
  {TE_L5PHIA3_L6PHIA3}
  {TE_L5PHIA3_L6PHIA4}
  {TE_L5PHIA3_L6PHIA5}
  {TE_L5PHIA3_L6PHIA6}
  {TE_L5PHIA3_L6PHIA7}
  {TE_L5PHIA3_L6PHIA8}
  {TE_L5PHIA3_L6PHIB9}
  {TE_L5PHIA4_L6PHIA4}
  {TE_L5PHIA4_L6PHIA5}
  {TE_L5PHIA4_L6PHIA6}
  {TE_L5PHIA4_L6PHIA7}
  {TE_L5PHIA4_L6PHIA8}
  {TE_L5PHIA4_L6PHIB10}
  {TE_L5PHIA4_L6PHIB11}
  {TE_L5PHIA4_L6PHIB9}
  {TE_L5PHIB5_L6PHIA6}
  {TE_L5PHIB5_L6PHIA7}
  {TE_L5PHIB5_L6PHIA8}
  {TE_L5PHIB5_L6PHIB10}
  {TE_L5PHIB5_L6PHIB11}
  {TE_L5PHIB5_L6PHIB12}
  {TE_L5PHIB5_L6PHIB13}
  {TE_L5PHIB5_L6PHIB9}
  {TE_L5PHIB6_L6PHIA8}
  {TE_L5PHIB6_L6PHIB10}
  {TE_L5PHIB6_L6PHIB11}
  {TE_L5PHIB6_L6PHIB12}
  {TE_L5PHIB6_L6PHIB13}
  {TE_L5PHIB6_L6PHIB14}
  {TE_L5PHIB6_L6PHIB15}
  {TE_L5PHIB6_L6PHIB9}
  {TE_L5PHIB7_L6PHIB10}
  {TE_L5PHIB7_L6PHIB11}
  {TE_L5PHIB7_L6PHIB12}
  {TE_L5PHIB7_L6PHIB13}
  {TE_L5PHIB7_L6PHIB14}
  {TE_L5PHIB7_L6PHIB15}
  {TE_L5PHIB7_L6PHIB16}
  {TE_L5PHIB7_L6PHIC17}
  {TE_L5PHIB8_L6PHIB12}
  {TE_L5PHIB8_L6PHIB13}
  {TE_L5PHIB8_L6PHIB14}
  {TE_L5PHIB8_L6PHIB15}
  {TE_L5PHIB8_L6PHIB16}
  {TE_L5PHIB8_L6PHIC17}
  {TE_L5PHIB8_L6PHIC18}
  {TE_L5PHIB8_L6PHIC19}
  {TE_L5PHIC10_L6PHIB16}
  {TE_L5PHIC10_L6PHIC17}
  {TE_L5PHIC10_L6PHIC18}
  {TE_L5PHIC10_L6PHIC19}
  {TE_L5PHIC10_L6PHIC20}
  {TE_L5PHIC10_L6PHIC21}
  {TE_L5PHIC10_L6PHIC22}
  {TE_L5PHIC10_L6PHIC23}
  {TE_L5PHIC11_L6PHIC18}
  {TE_L5PHIC11_L6PHIC19}
  {TE_L5PHIC11_L6PHIC20}
  {TE_L5PHIC11_L6PHIC21}
  {TE_L5PHIC11_L6PHIC22}
  {TE_L5PHIC11_L6PHIC23}
  {TE_L5PHIC11_L6PHIC24}
  {TE_L5PHIC11_L6PHID25}
  {TE_L5PHIC12_L6PHIC20}
  {TE_L5PHIC12_L6PHIC21}
  {TE_L5PHIC12_L6PHIC22}
  {TE_L5PHIC12_L6PHIC23}
  {TE_L5PHIC12_L6PHIC24}
  {TE_L5PHIC12_L6PHID25}
  {TE_L5PHIC12_L6PHID26}
  {TE_L5PHIC12_L6PHID27}
  {TE_L5PHIC9_L6PHIB14}
  {TE_L5PHIC9_L6PHIB15}
  {TE_L5PHIC9_L6PHIB16}
  {TE_L5PHIC9_L6PHIC17}
  {TE_L5PHIC9_L6PHIC18}
  {TE_L5PHIC9_L6PHIC19}
  {TE_L5PHIC9_L6PHIC20}
  {TE_L5PHIC9_L6PHIC21}
  {TE_L5PHID13_L6PHIC22}
  {TE_L5PHID13_L6PHIC23}
  {TE_L5PHID13_L6PHIC24}
  {TE_L5PHID13_L6PHID25}
  {TE_L5PHID13_L6PHID26}
  {TE_L5PHID13_L6PHID27}
  {TE_L5PHID13_L6PHID28}
  {TE_L5PHID13_L6PHID29}
  {TE_L5PHID14_L6PHIC24}
  {TE_L5PHID14_L6PHID25}
  {TE_L5PHID14_L6PHID26}
  {TE_L5PHID14_L6PHID27}
  {TE_L5PHID14_L6PHID28}
  {TE_L5PHID14_L6PHID29}
  {TE_L5PHID14_L6PHID30}
  {TE_L5PHID14_L6PHID31}
  {TE_L5PHID15_L6PHID26}
  {TE_L5PHID15_L6PHID27}
  {TE_L5PHID15_L6PHID28}
  {TE_L5PHID15_L6PHID29}
  {TE_L5PHID15_L6PHID30}
  {TE_L5PHID15_L6PHID31}
  {TE_L5PHID15_L6PHID32}
  {TE_L5PHID16_L6PHID28}
  {TE_L5PHID16_L6PHID29}
  {TE_L5PHID16_L6PHID30}
  {TE_L5PHID16_L6PHID31}
  {TE_L5PHID16_L6PHID32}
}
# module_to_export must correspond to the default macros set at the top of the
# test bench; otherwise, the C/RTL cosimulation will fail
set module_to_export TE_L1PHIC12_L2PHIB12

# create new project (deleting any existing one of same name)
open_project -reset trackletEngine

# source files
set CFLAGS {-std=c++11 -I../TrackletAlgorithm -I../TopFunctions}
add_files ../TopFunctions/TrackletEngineTop.cc -cflags "$CFLAGS"
add_files -tb ../TestBenches/TrackletEngine_test.cpp -cflags "$CFLAGS"

# data files
add_files -tb ../emData/TE/tables/
add_files -tb ../emData/TE/

foreach i $modules_to_test {
  puts [join [list "======== TESTING " $i " ========"] ""]
  set innerLayer [string range $i 3 4]
  set outerLayerIndex [string first "_" $i 5]
  set outerLayer [string range $i [expr $outerLayerIndex + 1] [expr $outerLayerIndex + 2]]
  set seed [join [list $innerLayer $outerLayer] ""]
  set innerTable [join [list "../emData/TE/tables/" $i "_stubptinnercut.tab"] ""]
  set outerTable [join [list "../emData/TE/tables/" $i "_stubptoutercut.tab"] ""]

  if { $seed == "L1L2" } {
    set top_func "TrackletEngine_PS_PS"
  } elseif { $seed == "L2L3" } {
    set top_func "TrackletEngine_PS_PS"
  } elseif { $seed == "L3L4" } {
    set top_func "TrackletEngine_PS_2S"
  } elseif { $seed == "L5L6" } {
    set top_func "TrackletEngine_2S_2S"
  }

  # set macros for this module in CCFLAG environment variable
  set ::env(CCFLAG) [join [list "-D \"SEED_=" $seed "_\" -D \"MODULE_=" $i "_\" -D \"TOP_FUNC_=" $top_func "\" -D \"INNER_TABLE_=\\\"" $innerTable "\\\"\" -D \"OUTER_TABLE_=\\\"" $outerTable "\\\"\""] ""]

  # run C-simulation for each module in modules_to_test
  set_top $top_func
  open_solution [join [list "solution_" $i] ""]

  # Define FPGA, clock frequency & common HLS settings.
  source settings_hls.tcl
  csim_design -mflags "-j8"

  # only run C-synthesis, C/RTL cosimulation, and export for module_to_export
  if { $i == $module_to_export } {
    csynth_design
    cosim_design
    export_design -format ip_catalog
    # Adding "-flow impl" runs full Vivado implementation, providing accurate resource use numbers (very slow).
    #export_design -format ip_catalog -flow impl
  }
}

exit
